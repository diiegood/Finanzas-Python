
import pandas as pd
import os
import numpy as np
import re

direccion = "J:\\Diego-files\\DENUE-datos\\"
libreria = "denue_Agricultura_11.csv"
lectura_Datos = os.path.join(direccion, libreria)

#para conocer las caracteristicas generales de la matriz y la lectura de los datos en codigo que acepte ñ
Comercio_al_por_Menor = pd.read_csv(lectura_Datos, encoding='latin1')

Comercio_al_por_Menor.head(30)
Comercio_al_por_Menor.dtypes #ver tipo de datos de cada variable del data frame
Comercio_al_por_Menor.isnull().values.any() #ver si hay alguna columna con un valor nulo
Comercio_al_por_Menor.columns #muestra las columnas 
Comercio_al_por_Menor.duplicated().sum() #muestra si hay columnas duplicadas
Comercio_al_por_Menor['per_ocu'].unique() #mostrar que valores tiene lo de los rangos poblacionales

#se reduce el data frame con las variables significativas.
Comercio_al_por_Menor = Comercio_al_por_Menor[['clee','nom_estab', 'raz_social','per_ocu','codigo_act','nombre_act','entidad','municipio','id']].fillna(0)

# Se cambio la variable de ("251 a mas personas a 251 a 1000 personas").
Comercio_al_por_Menor['per_ocu'] = Comercio_al_por_Menor['per_ocu'].replace({
    '251 y más personas': '251 a 500 personas'})

#se extraen los valores de la poblacion ocupada a solo los numeros
Comercio_al_por_Menor[['poblacion_minima', 'poblacion_maxima']] = Comercio_al_por_Menor['per_ocu'].astype(str).str.extract(r'(\d+\.?\d*)\D*(\d+\.?\d*)')        
Comercio_al_por_Menor['poblacion_minima'] = pd.to_numeric(Comercio_al_por_Menor['poblacion_minima'], errors='coerce') #se crea una columna poblacion minima
Comercio_al_por_Menor['poblacion_maxima'] = pd.to_numeric(Comercio_al_por_Menor['poblacion_maxima'], errors='coerce') #se crea otra columna poblacion maxima
#se eliminan las variables que no tengan razon social, para evitar empresas pequeñas o individuos que sean heterogenos y que esten agrupados en un conjunto grande
Comercio_al_por_Menor[Comercio_al_por_Menor["raz_social"] != 0] #filtra todos los que no tengna razon social
#se elimina la columna de #per ocu porque ya se separo los valores en dos columnas independientes
Comercio_al_por_Menor.drop(columns='per_ocu', inplace=True)





###############################################################################

#Agrupaciones.
#para sacar la poblacion total del data frame incluyendo empresas pequeñas
Comercio_al_por_Menor_empresas = (Comercio_al_por_Menor.groupby('nom_estab', as_index=False)[['poblacion_minima', 'poblacion_maxima']].sum())
Comercio_al_por_Menor.groupby('nom_estab')[['poblacion_minima', 'poblacion_maxima']].sum().reset_index()


poblacion_total_Agricultura = (Comercio_al_por_Menor.groupby('nom_estab', as_index=False)[['poblacion_minima', 'poblacion_maxima']].sum())
Comercio_al_por_Menor['Poblacion_promedio'] = Comercio_al_por_Menor[['poblacion_minima','poblacion_maxima']].mean (axis=1)



###############################################################################
#filtros

#para agregar dummies
tamano_dummies = pd.get_dummies(Comercio_al_por_Menor['tamano_empresa'], prefix='tamano')
###############################################################################
#para poner solo 3 dummies
tamano_dummies = pd.get_dummies(Comercio_al_por_Menor['tamano_empresa'], prefix='tamano', drop_first=True)

#crea nuevas columnas extrayendo los valores de los minimos y maximos de la poblacion.
#Comercio_al_por_Menor[['poblacion_minima', 'poblacion_maxima']] = Comercio_al_por_Menor['per_ocu'].astype(str).str.extract(r'(\d+\.?\d*)\D*(\d+\.?\d*)')
#limina la columna anterior donde tenia la poblacion general.
#para ver cuantas empresas tienen el tamaño 251 y mas 
filtro = Comercio_al_por_Menor['per_ocu'] == '251 a 1000 personas'
filtro = Comercio_al_por_Menor[filtro]
empresas_con_251_mas =  filtro.sum()      

###############################################################################



Comercio_al_por_Menor = Comercio_al_por_Menor['nom_estab'].drop_duplicates() 
Comercio_al_por_Menor = len(Comercio_al_por_Menor)
print('Sector Minero')
print('Total de empresas es de', Comercio_al_por_Menor )  
print('clave del sector va de', 21, 'con subsectores de', 211, 'hasta', 213 )
# Asegúrate de que los valores estén como números
Mineria['rango_poblacion'] = Mineria['poblacion_maxima'] - Mineria['poblacion_minima']
# Puedes elegir un umbral de diferencia máxima aceptable
umbral = 50  # Cambia este valor según qué tan estricto quieras el filtro
# Filtra los registros con diferencia menor al umbral
Mineria_filtrada = Mineria[Mineria['rango_poblacion'] <= umbral].copy()
# Opcional: elimina la columna de rango si no la necesitas después
# Mineria_filtrada.drop(columns='rango_poblacion', inplace=True)
# Mostrar resultados
print('Registros filtrados con menor diferencia entre población mínima y máxima:')
print(Mineria_filtrada.head())

valores_Mineria = Comercio_al_por_Menor["poblacion_maxima", "poblacion_minima" ].unique()
valores_Mineria

filtro_Mineria = Mineria [Mineria["per_ocu"] == "AUDITORIO MUNICIPAL"]
filtro_Mineria
