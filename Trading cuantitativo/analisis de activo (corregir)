import yfinance as yf
import pandas as pd
from datetime import datetime, timedelta
import quadprog 
import numpy as  np
import matplotlib.pyplot as plt
import scipy.stats as st
import os 
import math 
import seaborn as sns
from statsmodels.tsa.stattools import adfuller
from statsmodels.graphics.tsaplots import plot_acf, plot_pacf
from statsmodels.tsa.arima.model import ARIMA
from arch import arch_model
from datetime import timedelta
import seaborn as sns
import mplfinance as mpf

plt.style.use("dark_background")

"Analisis de la accion"

#activos a analizar  ##########################################################

#LIVEPOLC-1.MX
"WALMEX.MX", "ALFAA.MX","KOFUBL.MX","GFNORTEO.MX"

ticker = "GENTERA.MX"
ric = ticker

end_date = datetime.today().date()
start_date = end_date - timedelta(days=180)

# Descargar datos diarios
stock = yf.download(
    ticker,
    start=start_date.strftime("%Y-%m-%d"),
    end=end_date.strftime("%Y-%m-%d"),
    interval="1d" #frecuencia
    )

stock = stock[["Close"]].reset_index()

#stock.index.name = "Date"
stock.head()
stock.tail()
stock.shape
stock.info()


"Crear la serie de tiempo de la accion"

t = pd.DataFrame()  # Crear un data frame vacio , para guardar las columnas que se crearan

# Proceso de datos para los calculos
#si voy a meter una accion americana o extrangera cambiar Fecha a / Date  y Cierre a / Close
t["date"] = pd.to_datetime(stock["Date"], dayfirst=True )  # Convertir la columna "Date" a serie de tiempo
t["close"] = stock["Close"]  # Asignar la columna "Close"
t = t.sort_values(by="date", ascending=True)  # Ordenar por fecha
t["close_previous"] = t["close"].shift(1)  # Crear columna del cierre anterior


"Formas de Calcular el rendimiento"   #########################################
#t["return_close"] = t["close"] / t["close_previous"] - 1 #rendimiento en base a (P1 / P0)
t["return_close"] =  np.log(t["close"] / t["close_previous"]) #rendimiento en base a log(P1/P0)
#t["return_close"] = raw_data["Cierre"].pct_change()  #rendimiento en base a ((P1 - P0 )/P0)-1
t["log_return"] = np.log(t["close"]/t["close"].shift(1))
t["log_return"].dropna().plot()
t = t.dropna()  # Eliminar filas con valores NaN
t = t.reset_index(drop=True)  # Reiniciar el i­ndice


t["close"].plot(title="Precio de Cierre del activo: " + str(ticker), figsize=(12, 5))
plt.show()
t["close"].rolling(window=30).mean().plot(title="Media Movil 30 dias")

t["return_close"].plot(title="Rendimientos del activo " + str(ticker))


#en esta prueba se obtiene un adf de -12.98 por lo que quiere decir que esta abajo de 
#los niveles criticos comunes:
    
    #valores criticos
    #1%  -3.5
    #5%  -2.9
    #10% -2.6
    
#al ser -12.98 menor a -3.5 se rechaza con alta confianza la hipotesis nula
 
result = adfuller(t["return_close"].dropna())
print(f"ADF stadistic: {result[0]}" )  #es negativo indica fuerte evidencia contra la hipotesis nula
print(f"p-value:  {result[1]}" )  #muy bajo comparado on cualquier nivel de significancia de 0.05 o 0.01
#no requiere diferenciar, se puede usar un ARIMA o un GARCH

"""
Augmented Dickjey Fuller:, se busca en la prueba ver en serie temporal si es estacionaria
Ho = hipotesis nula la serie tiene raiz unitaria quiere decir que no es estacionaria, tiene
tendencia o memoria a largo plazo

H1 = es hipotesis alternativa es estacionaria por lo que su media su varianza y covarianza 
son constantes en el tiempo
"""


"""
Intervalos de confianza: 
p-value	      Intervalo de confianza	Conclusión	Significado
p < 0.01	     99%	Rechazas H₀ con alta confianza	Serie estacionaria con fuerte evidencia
0.01 ≤ p ≤ 0.05	 95%	Rechazas H₀ con moderada confianza	Serie probablemente estacionaria
0.05 < p ≤ 0.10	 90%	Dudosa, apenas suficiente para rechazar H₀	Posiblemente estacionaria, no concluyente
p > 0.10		            No rechazas H₀	Serie no es estacionaria


99% de confianza es alfa=0.01
95% de confianza es alfa=0.05
90% de confianza es alfa=0.10
"""


"""
si el p<0.01 con un 99% de confianza se puede decir que la serie es estacionaria

si el p-value esta entre 0.01 y 0.05 se puede decir con un 95% que se rechaza HO con un 95% / 5% de estar
equivocado de que Ho rechazo de hipotesis nula, es buena evidencia para rechzarla pero no tan buena
que si se rechaza Ho con que el p-value < 0.01, es mejor asegurar con un intervalo de 99% osea un
p-value menor a 0.01 que uno entre 0.01 y 0.05 que seria con un intervalo de 95%

si el p-value > 0.05 , la hipotesis nula sigue en pie de que ser no estacionaria.
seria conveniente transformar la serie antes de usar un ARIMA

si el p-value es menor a 0.05 se rechaza la Hipotesis nula Ho y la serie es estacionaria o se
asume que es estacionaria.

si el p-value es mayor a 0.05 quiere decir que la serie no es estacionaria y no se recahza la hipotesis nula

###############################################################################

Teorias de Hipotesis:

Ayudan a  tomar decisiones estadisticas, donde se evaluan 
los datos que se observan apoyando una supocision sobre la poblacion

hay dos hipotesis por cada prueba:
    
    1) Hipotesis Nula o H0 - Dice que la supocisiuon de lo que se quiere poner
    a prueba se representa con una condicion de no efecto
    
    2)Hipotesis Alternativa H1-Acepta si los datos contradicen H0 reppresenta
    el cambio o la diferencia con respecto a H0

"""


